<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geolocation Concurrency: GCP vs Watch</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
            background-color: #f4f4f9;
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            align-items: center;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .input-group {
            display: flex;
            align-items: center;
            margin-right: 10px;
        }
        .input-group label {
            font-weight: 600;
            margin-right: 8px;
            color: #333;
        }
        input[type="number"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 60px;
            font-size: 14px;
        }
        button {
            padding: 12px 20px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: 600;
            transition: background 0.2s;
        }
        .btn-gcp { background-color: #007bff; } /* Blue */
        .btn-gcp:hover { background-color: #0056b3; }
        
        .btn-watch { background-color: #e88b00; } /* Orange */
        .btn-watch:hover { background-color: #cc7a00; }

        .btn-mix { background-color: #6f42c1; } /* Purple */
        .btn-mix:hover { background-color: #553098; }

        .btn-stop { background-color: #dc3545; } /* Red */
        .btn-stop:hover { background-color: #a71d2a; }

        #console-container {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #333;
        }
        .log-entry {
            margin-bottom: 4px;
            border-bottom: 1px solid #333;
            padding-bottom: 4px;
            font-size: 13px;
            line-height: 1.4;
        }
        .info { color: #569cd6; } 
        .success { color: #6a9955; } 
        .watch-update { color: #dcdcaa; } /* Yellowish */
        .error { color: #f44747; } 
        .timestamp { color: #888; margin-right: 8px; user-select: none; }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-right: 5px;
            color: #1e1e1e;
            font-weight: bold;
        }
        .badge-gcp { background-color: #6a9955; }
        .badge-watch { background-color: #e88b00; }
    </style>
</head>
<body>

    <h1>Geolocation Method Stress Test</h1>
    <p>
        <strong>GCP:</strong> Fires <code>getCurrentPosition</code> (One-shot).<br>
        <strong>Watch:</strong> Fires <code>watchPosition</code> (Continuous stream).
    </p>
    
    <div class="controls">
        <div class="input-group">
            <label for="batch-size">Batch Size:</label>
            <input type="number" id="batch-size" value="10" min="1" max="100">
        </div>

        <button class="btn-gcp" onclick="startTest('GCP')">Fire Batch GCP</button>
        <button class="btn-watch" onclick="startTest('WATCH')">Fire Batch Watch</button>
        <button class="btn-mix" onclick="startTest('MIX')">Fire Both (Mix)</button>
        <button class="btn-stop" onclick="stopAndClear()">â›” Stop & Clear Logs</button>
    </div>

    <div id="console-container">
        <div>Ready...</div>
    </div>

    <script>
        const logContainer = document.getElementById('console-container');
        let activeWatchIds = []; // Track active watchers to clear them later

        const geoOptions = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        };

        function getBatchSize() {
            const val = document.getElementById('batch-size').value;
            // Default to 10 if empty or invalid
            return parseInt(val) > 0 ? parseInt(val) : 10;
        }

        function addLog(message, type = 'normal') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const now = new Date();
            const timeString = now.toLocaleTimeString() + '.' + String(now.getMilliseconds()).padStart(3, '0');
            entry.innerHTML = `<span class="timestamp">[${timeString}]</span> ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function stopAndClear() {
            // 1. Clear all active watchers
            if (activeWatchIds.length > 0) {
                activeWatchIds.forEach(id => navigator.geolocation.clearWatch(id));
                addLog(`â›” Stopped ${activeWatchIds.length} active watchers.`, "info");
                activeWatchIds = [];
            }
            // 2. Clear visual logs
            logContainer.innerHTML = '';
            addLog("Logs cleared. Ready for next test.", "info");
        }

        function startTest(mode) {
            // Optional cleanup
            if (activeWatchIds.length > 0 && (mode === 'WATCH' || mode === 'MIX')) {
                addLog(`âš ï¸ Clearing ${activeWatchIds.length} previous watchers before starting...`, "error");
                activeWatchIds.forEach(id => navigator.geolocation.clearWatch(id));
                activeWatchIds = [];
            }

            const count = getBatchSize();
            addLog(`ðŸš€ Starting Test: <strong>${mode}</strong> with Batch Size: <strong>${count}</strong>`, "info");

            if (mode === 'WATCH' || mode === 'MIX') {
                fireBatchWatch(count);
            }
            if (mode === 'GCP' || mode === 'MIX') {
                fireBatchGCP(count);
            }
        }

        function fireBatchGCP(count) {
            addLog(`--> Firing ${count} getCurrentPosition (GCP) requests...`, "info");
            for (let i = 1; i <= count; i++) {
                const reqId = i;
                const start = Date.now();
                
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const dur = Date.now() - start;
                        const coords = `${pos.coords.latitude.toFixed(5)},${pos.coords.longitude.toFixed(5)}`;
                        addLog(`<span class="badge badge-gcp">GCP #${reqId}</span> Success (${dur}ms): ${coords}`, "success");
                    },
                    (err) => {
                        const dur = Date.now() - start;
                        addLog(`<span class="badge badge-gcp">GCP #${reqId}</span> Failed (${dur}ms): ${err.message}`, "error");
                    },
                    geoOptions
                );
            }
        }

        function fireBatchWatch(count) {
            addLog(`--> Firing ${count} watchPosition (WATCH) requests...`, "info");
            for (let i = 1; i <= count; i++) {
                const reqId = i;
                
                const watchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        const coords = `${pos.coords.latitude.toFixed(5)},${pos.coords.longitude.toFixed(5)}`;
                        const acc = Math.round(pos.coords.accuracy);
                        addLog(`<span class="badge badge-watch">WATCH #${reqId}</span> Update [ID:${watchId}]: ${coords} (Acc:${acc}m)`, "watch-update");
                    },
                    (err) => {
                        addLog(`<span class="badge badge-watch">WATCH #${reqId}</span> Error [ID:${watchId}]: ${err.message}`, "error");
                    },
                    geoOptions
                );
                
                activeWatchIds.push(watchId);
            }
            addLog(`--> Registered ${activeWatchIds.length} watchers`, "info");
        }
    </script>
</body>
</html>
