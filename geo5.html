<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geolocation Element & Null Window Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
            line-height: 1.6;
        }
        .case-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        h2 { margin-top: 0; color: #333; }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover { background-color: #0056b3; }
        .log {
            background-color: #333;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            min-height: 100px;
        }
        .warning {
            color: #d9534f;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h1>&lt;geolocation&gt; Element Crash Tests</h1>
    <p>Testing <code>&lt;geolocation&gt;</code> element behavior in documents with <strong>null domWindow</strong>.</p>

    <div class="case-container">
        <h2>Case 1: Detached "Zombie" Document</h2>
        <p>Creates an iframe, injects <code>&lt;geolocation&gt;</code>, then removes the iframe.</p>
        <button id="btn-zombie">Run Zombie Test</button>
        <div id="log-zombie" class="log">Waiting...</div>
    </div>

    <div class="case-container">
        <h2>Case 2: Synthetic Document (createDocument)</h2>
        <p>Uses <code>document.implementation.createDocument</code>.</p>
        <button id="btn-synthetic">Run Synthetic Test</button>
        <div id="log-synthetic" class="log">Waiting...</div>
    </div>

    <div class="case-container">
        <h2>Case 3: DOMParser</h2>
        <p>Uses <code>new DOMParser().parseFromString(...)</code>.</p>
        <button id="btn-parser">Run DOMParser Test</button>
        <div id="log-parser" class="log">Waiting...</div>
    </div>

    <div class="case-container">
        <h2>Case 4: CloneNode + document.write</h2>
        <p>Uses <code>document.cloneNode()</code> followed by <code>doc.write()</code>.</p>
        <button id="btn-clone">Run CloneNode Test</button>
        <div id="log-clone" class="log">Waiting...</div>
    </div>

    <script>
        // --- UTILITY ---
        function log(elementId, message) {
            const el = document.getElementById(elementId);
            const time = new Date().toLocaleTimeString();
            el.textContent += `[${time}] ${message}\n`;
        }
        function clearLog(elementId) {
            document.getElementById(elementId).textContent = "";
        }

        // --- CASE 1: ZOMBIE DOCUMENT ---
        document.getElementById('btn-zombie').addEventListener('click', () => {
            clearLog('log-zombie');
            log('log-zombie', 'Initializing Zombie test...');
            try {
                const parentIframe = document.createElement('iframe');
                parentIframe.style.display = 'none';
                document.body.appendChild(parentIframe);
                const zombieDoc = parentIframe.contentDocument;
                
                // Add <geolocation>
                const geoTag = zombieDoc.createElement('geolocation');
                geoTag.id = "zombie-geo";
                zombieDoc.body.appendChild(geoTag);
                log('log-zombie', '1. Injected <geolocation> into iframe.');

                // Detach
                parentIframe.remove();
                log('log-zombie', '2. Removed iframe (Zombie created).');

                if (zombieDoc.defaultView === null) {
                    log('log-zombie', '   [Status] defaultView is NULL.');
                }

                // Interact
                const el = zombieDoc.getElementById('zombie-geo');
                if (el) {
                    el.setAttribute('test-attr', '1');
                    log('log-zombie', '3. Modified attribute on <geolocation> in zombie doc.');
                }
            } catch (e) {
                log('log-zombie', `ERROR: ${e.message}`);
            }
        });

        // --- CASE 2: SYNTHETIC DOCUMENT ---
        document.getElementById('btn-synthetic').addEventListener('click', () => {
            clearLog('log-synthetic');
            log('log-synthetic', 'Initializing Synthetic test...');
            try {
                const doc = document.implementation.createDocument("http://www.w3.org/1999/xhtml", "html", null);
                
                if (doc.defaultView === null) log('log-synthetic', '[Status] defaultView is NULL.');

                const body = doc.createElement("body");
                doc.documentElement.appendChild(body);

                const geoTag = doc.createElement('geolocation');
                geoTag.id = "syn-geo";
                body.appendChild(geoTag);
                log('log-synthetic', '1. Injected <geolocation> into synthetic doc.');

                geoTag.setAttribute('test-attr', '2');
                log('log-synthetic', '2. Modified attribute.');
            } catch (e) {
                log('log-synthetic', `ERROR: ${e.message}`);
            }
        });

        // --- CASE 3: DOMParser ---
        document.getElementById('btn-parser').addEventListener('click', () => {
            clearLog('log-parser');
            log('log-parser', 'Initializing DOMParser test...');
            try {
                const parser = new DOMParser();
                // Parsing string as requested
                const doc = parser.parseFromString("<document><geolocation id='test-parser'></geolocation></document>", "text/html");

                if (doc.defaultView === null) {
                    log('log-parser', '[Status] parsedDoc.defaultView is NULL.');
                }

                // Finding the element. 
                // Note: parseFromString with "text/html" creates head/body. 
                // Our <geolocation> might be inside <body> depending on parser rules for unknown tags.
                const el = doc.querySelector('geolocation');
                
                if (el) {
                    log('log-parser', '1. Found <geolocation> element parsed from string.');
                    el.setAttribute('test-attr', '3');
                    log('log-parser', '2. Modified attribute on parsed element.');
                } else {
                    log('log-parser', 'Warning: <geolocation> element not found in parsed tree.');
                }
            } catch (e) {
                log('log-parser', `ERROR: ${e.message}`);
            }
        });

        // --- CASE 4: CloneNode + Write ---
        document.getElementById('btn-clone').addEventListener('click', () => {
            clearLog('log-clone');
            log('log-clone', 'Initializing CloneNode test...');
            try {
                // 1. Clone the current document (shallow or deep shouldn't matter for the window status)
                const clonedDoc = document.cloneNode(false);
                
                if (clonedDoc.defaultView === null) {
                    log('log-clone', '[Status] clonedDoc.defaultView is NULL.');
                }

                // 2. Attempt document.write
                // Note: document.write usually requires an open document stream. 
                // On a detached clone, this might throw or silently fail in some browsers.
                log('log-clone', '1. Attempting doc.write("<geolocation id=test>")...');
                
                try {
                    clonedDoc.write("<geolocation id='test-clone'></geolocation>");
                    log('log-clone', '2. doc.write executed without throwing JS error.');
                    
                    // 3. Verify element existence
                    // write() on a clone might not construct the DOM as expected if it's not "open".
                    // We check if it exists.
                    // If write() failed to parse, we manually inject to ensure we test the C++ element logic.
                    let el = clonedDoc.getElementById('test-clone');
                    if (!el) {
                        // Fallback if write() is inert on clones
                        log('log-clone', '   (write() did not create DOM, falling back to createElement to ensure test coverage)');
                        const body = clonedDoc.createElement('
