<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geolocation Element & Null Window Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
            line-height: 1.6;
        }
        .case-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        h2 { margin-top: 0; color: #333; }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover { background-color: #0056b3; }
        .log {
            background-color: #333;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            min-height: 100px;
        }
        .warning {
            color: #d9534f;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h1>&lt;geolocation&gt; Element Tests</h1>
    <p>Testing the behavior of the specific <code>&lt;geolocation&gt;</code> element in documents with null <code>domWindow</code>.</p>

    <div class="case-container">
        <h2>Case 1: Detached "Zombie" Document</h2>
        <p>
            Creates an iframe, injects a <code>&lt;geolocation&gt;</code> element, and then removes the iframe.
        </p>
        <p class="warning">
            The document remains in memory (Zombie), but has no window. We then attempt to access the &lt;geolocation&gt; element.
        </p>
        <button id="btn-zombie">Run Zombie Test</button>
        <div id="log-zombie" class="log">Waiting to create zombie document...</div>
    </div>

    <div class="case-container">
        <h2>Case 2: Synthetic Document</h2>
        <p>
            Uses <code>document.implementation.createDocument</code> to create a document that never had a window, containing a <code>&lt;geolocation&gt;</code> element.
        </p>
        <button id="btn-synthetic">Run Synthetic Test</button>
        <div id="log-synthetic" class="log">Waiting to create synthetic document...</div>
    </div>

    <script>
        // --- UTILITY: LOGGER ---
        function log(elementId, message) {
            const el = document.getElementById(elementId);
            const time = new Date().toLocaleTimeString();
            el.textContent += `[${time}] ${message}\n`;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).textContent = "";
        }

        // --- CASE 1: ZOMBIE DOCUMENT TEST ---
        document.getElementById('btn-zombie').addEventListener('click', () => {
            clearLog('log-zombie');
            log('log-zombie', 'Initializing Zombie test...');

            try {
                // 1. Create the browsing context (iframe)
                const parentIframe = document.createElement('iframe');
                parentIframe.style.display = 'none';
                document.body.appendChild(parentIframe);
                
                // 2. Keep reference to the document
                const zombieDoc = parentIframe.contentDocument;
                log('log-zombie', '1. Created temporary iframe.');

                // 3. Create and append the <geolocation> element
                const geoTag = zombieDoc.createElement('geolocation');
                geoTag.id = "target-geo-tag";
                // Add some attributes in case your engine checks them on insertion
                geoTag.setAttribute('mode', 'auto'); 
                zombieDoc.body.appendChild(geoTag);
                
                log('log-zombie', '2. Injected <geolocation> element into iframe.');

                // 4. Detach (Shutdown)
                parentIframe.remove();
                log('log-zombie', '3. REMOVED parent iframe (Document is now detached).');

                // 5. Verify Null Window
                if (zombieDoc.defaultView === null) {
                    log('log-zombie', '   [Status] zombieDoc.defaultView is NULL.');
                }

                // 6. Access the element in the dead document
                const lingeringEl = zombieDoc.getElementById('target-geo-tag');
                if (lingeringEl) {
                    log('log-zombie', '4. Accessing <geolocation> element in detached doc...');
                    
                    // Modify attribute to trigger C++ attributeChanged callbacks
                    lingeringEl.setAttribute('status', 'active');
                    log('log-zombie', '5. Modified attribute on <geolocation> (Did not crash).');
                }
            } catch (e) {
                log('log-zombie', `ERROR: ${e.message}`);
                console.error(e);
            }
        });

        // --- CASE 2: SYNTHETIC DOCUMENT TEST ---
        document.getElementById('btn-synthetic').addEventListener('click', () => {
            clearLog('log-synthetic');
            log('log-synthetic', 'Initializing Synthetic test...');

            try {
                // 1. Create Synthetic Document (No Window)
                const syntheticDoc = document.implementation.createDocument(
                    "http://www.w3.org/1999/xhtml", 
                    "html", 
                    null
                );

                if (syntheticDoc.defaultView === null) {
                    log('log-synthetic', '1. [Status] syntheticDoc.defaultView is NULL.');
                }

                // 2. Build Structure
                const body = syntheticDoc.createElement("body");
                syntheticDoc.documentElement.appendChild(body);

                // 3. Create the <geolocation> element
                const geoTag = syntheticDoc.createElement('geolocation');
                geoTag.setAttribute('id', 'syn-geo');
                body.appendChild(geoTag);

                log('log-synthetic', '2. Injected <geolocation> element into synthetic doc.');

                // 4. Manipulate the element
                // This tests if your element's logic handles being in a windowless doc
                log('log-synthetic', '3. Modifying <geolocation> attributes...');
                geoTag.setAttribute('test-attr', 'value');
                
                log('log-synthetic', '4. Success: Attribute set on synthetic <geolocation>.');

            } catch (e) {
                log('log-synthetic', `ERROR: ${e.message}`);
                console.error(e);
            }
        });
    </script>
</body>
</html>
